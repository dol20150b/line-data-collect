<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบส่งรูปโหวต</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .preview-img { max-width: 100%; margin-top: 10px; border-radius: 8px; display: none; }
        #loading { display: none; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container" style="max-width: 500px;">
        <h4 class="mb-3 text-center">ส่งรูปภาพโหวต</h4>
        
        <form id="voteForm">
            <div class="mb-3">
                <label class="form-label">ผู้ส่ง:</label>
                <input type="text" id="displayName" class="form-control" readonly value="Loading...">
            </div>

            <div class="mb-3">
                <label class="form-label">รูปภาพโหวต:</label>
                <input type="file" id="imageFile" class="form-control" accept="image/*" required>
                <img id="preview" class="preview-img">
            </div>

            <div class="mb-3">
                <label class="form-label">จำนวนโหวต:</label>
                <select id="voteCount" class="form-select" required>
                    <option value="" disabled selected>เลือกจำนวนโหวต</option>
                    </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">ส่งข้อมูล</button>
        </form>

        <div id="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p>กำลังบันทึกข้อมูล...</p>
        </div>
    </div>

    <script>
        // --- ส่วนตั้งค่า (แก้ไขตรงนี้) ---
        const LIFF_ID = "2008774166-NdGxK2ZT"; // ใส่ LIFF ID ที่ได้จาก LINE Developers
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwzm4ZYiEcqUC7NTzOFaaxq8cjhrvB6lN2DJNsZTM6HiM6_fQ_sgKOJL_qQnhwh-_TTFQ/exec"; // ใส่ URL ที่ได้จากการ Deploy ข้อ 1
        // -----------------------------

        // สร้างตัวเลือก 1-30
        const select = document.getElementById('voteCount');
        for (let i = 1; i <= 30; i++) {
            let opt = document.createElement('option');
            opt.value = i;
            opt.innerHTML = i;
            select.appendChild(opt);
        }

        // Preview รูปภาพเมื่อเลือก
        const fileInput = document.getElementById('imageFile');
        const preview = document.getElementById('preview');
        
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        // เริ่มการทำงาน LIFF
        async function main() {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('displayName').value = profile.displayName;
            } else {
                liff.login();
            }
        }
        main();

        // เมื่อกดส่งข้อมูล
        document.getElementById('voteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = fileInput.files[0];
            if (!file) { alert("กรุณาเลือกรูปภาพ"); return; }

            document.getElementById('loading').style.display = 'block';
            document.querySelector('button[type="submit"]').disabled = true;

            // แปลงไฟล์เป็น Base64
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                const base64 = reader.result;
                const data = {
                    lineName: document.getElementById('displayName').value,
                    voteCount: document.getElementById('voteCount').value,
                    image: base64,
                    fileName: file.name,
                    mimeType: file.type
                };

                // ส่งข้อมูลไป Google Script
                try {
                    await fetch(WEB_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify(data),
                        mode: 'no-cors' // จำเป็นสำหรับ GAS
                    });
                    
                    alert("บันทึกข้อมูลเรียบร้อยแล้ว!");
                    liff.closeWindow(); // ปิดหน้าต่างเมื่อเสร็จ
                } catch (err) {
                    alert("เกิดข้อผิดพลาด: " + err);
                    document.getElementById('loading').style.display = 'none';
                    document.querySelector('button[type="submit"]').disabled = false;
                }
            };
        });
    </script>
</body>
</html>
